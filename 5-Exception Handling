CREATE TABLE Borrower (Roll INT PRIMARY KEY, Name VARCHAR(50), DateofIssue DATE, NameofBook VARCHAR(100), Status CHAR(1));
CREATE TABLE Fine (Roll INT, Date DATE, Amt DECIMAL(10,2));

INSERT INTO Borrower VALUES (101, 'Om', '2025-10-10', 'DBMS', 'I'), (102, 'Amit', '2025-10-20', 'Networking', 'I'), (103, 'Rahul', '2025-09-25', 'Java', 'I'), (104, 'Sneha', '2025-11-01', 'Python', 'I');

DELIMITER //
CREATE PROCEDURE ReturnBook(IN p_roll INT, IN p_book VARCHAR(100))
BEGIN
  DECLARE v_date DATE; DECLARE v_days INT; DECLARE v_fine DECIMAL(10,2) DEFAULT 0;
  DECLARE EXIT HANDLER FOR SQLEXCEPTION SELECT 'Error: Invalid Roll or Book!' AS Message;
  
  SELECT DateofIssue INTO v_date FROM Borrower WHERE Roll = p_roll AND NameofBook = p_book AND Status = 'I';
  SET v_days = DATEDIFF(CURDATE(), v_date);
  
  IF v_days > 30 THEN SET v_fine = v_days * 50;
  ELSEIF v_days BETWEEN 15 AND 30 THEN SET v_fine = v_days * 5;
  ELSE SET v_fine = 0;
  END IF;
  
  UPDATE Borrower SET Status = 'R' WHERE Roll = p_roll AND NameofBook = p_book;
  IF v_fine > 0 THEN INSERT INTO Fine VALUES (p_roll, CURDATE(), v_fine); END IF;
  SELECT CONCAT('Book returned successfully! Days Kept: ', v_days, ', Fine: Rs ', v_fine) AS Result;
DELIMITER ;
CALL ReturnBook(101, 'DBMS');
SELECT * FROM Borrower;
SELECT * FROM Fine;
