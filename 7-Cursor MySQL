-- ===========================================================
-- MYSQL – CURSORS PRACTICAL (ALL IN ONE)
-- ===========================================================

-- -----------------------------
-- 1. CREATE TABLES
-- -----------------------------
CREATE TABLE Cust_Old (
    Cust_Id INT PRIMARY KEY,
    Cust_Name VARCHAR(50),
    City VARCHAR(50)
);

CREATE TABLE Cust_New (
    Cust_Id INT,
    Cust_Name VARCHAR(50),
    City VARCHAR(50)
);

-- -----------------------------
-- 2. INSERT SAMPLE DATA
-- -----------------------------
INSERT INTO Cust_Old VALUES (101, 'Amit', 'Pune');
INSERT INTO Cust_Old VALUES (102, 'Rahul', 'Mumbai');

INSERT INTO Cust_New VALUES (101, 'Amit', 'Pune');   -- duplicate
INSERT INTO Cust_New VALUES (103, 'Sneha', 'Nashik'); -- new
INSERT INTO Cust_New VALUES (104, 'John', 'Delhi');   -- new

-- ===========================================================
-- 3. MYSQL DOES NOT SUPPORT IMPLICIT CURSORS
-- (But INSERT shows affected rows)
-- ===========================================================
INSERT INTO Cust_Old VALUES (105, 'Karan', 'Satara');
SELECT ROW_COUNT() AS Inserted_Rows;

-- ===========================================================
-- 4. EXPLICIT CURSOR – DISPLAY Cust_Old
-- ===========================================================
DELIMITER $$

CREATE PROCEDURE Show_Customers()
BEGIN
    DECLARE done INT DEFAULT 0;
    DECLARE v_id INT;
    DECLARE v_name VARCHAR(50);
    DECLARE v_city VARCHAR(50);

    DECLARE cur1 CURSOR FOR
        SELECT Cust_Id, Cust_Name, City FROM Cust_Old;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

    OPEN cur1;

    read_loop: LOOP
        FETCH cur1 INTO v_id, v_name, v_city;
        IF done = 1 THEN
            LEAVE read_loop;
        END IF;
        SELECT CONCAT(v_id, ' - ', v_name, ' - ', v_city) AS Record;
    END LOOP;

    CLOSE cur1;
END$$

DELIMITER ;

CALL Show_Customers();

-- ===========================================================
-- 5. PARAMETERIZED CURSOR – MERGE Cust_New → Cust_Old
-- ===========================================================
DELIMITER $$

CREATE PROCEDURE Merge_Customers()
BEGIN
    DECLARE done INT DEFAULT 0;
    DECLARE p_id INT;

    -- Cursor to fetch only IDs from Cust_New
    DECLARE cur_ids CURSOR FOR
        SELECT Cust_Id FROM Cust_New;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

    OPEN cur_ids;

    merge_loop: LOOP
        FETCH cur_ids INTO p_id;
        IF done = 1 THEN
            LEAVE merge_loop;
        END IF;

        -- Check if record already exists
        IF NOT EXISTS (SELECT 1 FROM Cust_Old WHERE Cust_Id = p_id) THEN
            -- Insert full row using parameter
            INSERT INTO Cust_Old
            SELECT * FROM Cust_New WHERE Cust_Id = p_id;
            SELECT CONCAT('Inserted: ', p_id) AS Status;
        ELSE
            SELECT CONCAT('Skipped (Already Exists): ', p_id) AS Status;
        END IF;
    END LOOP;

    CLOSE cur_ids;
END$$

DELIMITER ;

CALL Merge_Customers();
